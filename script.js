let socket;let deviceAuth;const sendToWs=(msg)=>socket.send(JSON.stringify(msg));const waitForWsMessage=async(type,timeout=5000)=>{const getMessage=(event,resolve)=>{const message=JSON.parse(event.data);if(message.type===type)resolve({success:true,response:message});};const message=await new Promise((resolve)=>{socket.addEventListener('message',(event)=>getMessage(event,resolve));setTimeout(()=>resolve({success:false,response:'timeout'}),timeout);});socket.removeEventListener('message',getMessage);return message;};const epicButton=document.getElementById('loginBtn');const replitButton=document.getElementById('replitBtn');const cloneButton=document.getElementById('cloneBtn');const copyButton=document.getElementById('copyBtn');const startButton=document.getElementById('startBtn');const urlInput=document.getElementById('replitInput');const submitButton=document.getElementById('submitBtn');const loginWithEpic=()=>{const y=window.top.outerHeight/2+window.top.screenY-(800/2);const x=window.top.outerWidth/2+window.top.screenX-(500/2);const newWindow=window.open(`about:blank`,'Epic Games Login',`resizeable=off,width=500,height=800,top=${y},left=${x}`);asyncLoginWithEpic(newWindow);};const asyncLoginWithEpic=async(newWindow)=>{socket=new WebSocket('wss://partybot.net/ws');await new Promise((res)=>socket.addEventListener('open',res,{once:true}));epicButton.disabled=true;sendToWs({type:'start_device_code_process'});const deviceCode=await waitForWsMessage('update_device_code_link');if(!deviceCode.success){alert(`There was an error opening the login window. Please try again!`);epicButton.disabled=false;return;}
newWindow.location=`https://epicgames.com/id/logout?redirectUrl=${encodeURIComponent(deviceCode.response.content)}`;const deviceAuthMessage=await waitForWsMessage('recieve_authorization_code',300000);if(!newWindow.closed)newWindow.close();if(!deviceAuthMessage.success){alert(`There was an error verifying your login. Please try again!`);epicButton.disabled=false;}else{deviceAuth=JSON.parse(deviceAuthMessage.response.content);replitButton.disabled=false;}};const openSocialUrl=(url)=>{window.open(`https://${url}`,'_blank');};const replitSignup=()=>{replitButton.disabled=true;window.open('https://repl.it/signup','_blank');cloneButton.disabled=false;};const clonePartybot=()=>{cloneButton.disabled=true;window.open('https://repl.it/github/xMistt2/partybot','_blank');copyButton.disabled=false;};const copyDeviceAuth=()=>{copyButton.disabled=true;const textarea=document.createElement('textarea');textarea.textContent=`DEVICE_ID="${deviceAuth.deviceId}"\nACCOUNT_ID="${deviceAuth.accountId}"\nSECRET="${deviceAuth.secret}"`;textarea.style.position='fixed';document.body.appendChild(textarea);textarea.select();try{document.execCommand('copy');}catch(err){alert('Failed copying device auth to the clipboard!');}
document.body.removeChild(textarea);copyButton.innerHTML='<p>Successfully copied to clipboard!</p>';startButton.disabled=false;};let pressedStartReplit=false;const startReplit=()=>{startButton.disabled=true;alert('Go back to your repl.it, click start & then copy the url');pressedStartReplit=true;};const inputChange=()=>{if(urlInput.value.length>0&&pressedStartReplit)submitButton.disabled=false;else{submitButton.disabled=true;urlInput.value='';}};const submitReplit=async()=>{submitButton.disabled=true;const url=urlInput.value;try{const resp=await fetch('/api/upload-repl-url',{method:'POST',body:JSON.stringify({url,}),headers:{'Content-Type':'application/json',},});if(resp.ok()){alert('Your bot has successfully been started, enjoy!');}else{const responseData=await resp.json();if(responseData.exception){if(responseData.exception==='ClientConnectorSSLError'){alert('Failed to add bot as it has not been started, please start your bot.');}else alert(`Unknown error: ${data.exception}, please report it in the discord.`);}else if(responseData.error==='url_already_submitted'){alert(responseData.message);}else alert(responseData-error);submitButton.disabled=false;}}catch(err){console.log(err);alert('Cannot submit bot. Please try again!');submitButton.disabled=false;}};